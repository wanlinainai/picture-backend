## 用户传图
> 在进行用户的URL上传图片操作中，需要注意的问题是：
> 1. 验证URL格式
> 2. 校验URL协议
> 3. 发送HEAD请求验证文件是否存在
> 4. 校验文件类型
> 5. 校验文件大小

### 由于这个根据URL上传图片的功能跟之前的 文件上传有很多相似之处，我们还需要将这个进行拆分
#### 模版方法

## 缓存优化
1. 高频访问的数据：如首页、热门推荐内容
2. 计算成本较高的数据：如复杂查询结果，大量数据的统计结果
3. 允许短时间延迟的数据：排行榜、图片列表等
### Redis分布式缓存
### 本地缓存caffeine

## 图片上传优化
### 图片压缩
#### WebP：相较于PNG文件来说小了大约26%，比JPEG文件小25-34%
#### AVIF：基于AV1视频编码格式图片压缩，压缩率更高。但是兼容性会差一些

## 文件秒传
### 实现方案
（1） 客户端生成文件唯一标识：上传前，通过客户端计算文件的哈希值（MD5、SHA-256），生成唯一指纹。<br>
（2） 服务端校验文件指纹：后端接收到文件指纹之后，在存储中查询是否已存在相同文件。
- 存在相同文件，直接返回文件的存储路径。
- 不存在文件，接收到文件指纹并存储文件，同时记录其指纹信息。
### 问题
文件重复比较小，重复文件很少，另一个是用到了第三方存储，只能通过唯一地址去访问提取文件，无法完全自定义文件的存储结构、不支持文件快捷方式等概念，因此秒传文件地址必须使用和原本文件相同的路径对象路径，比如：用户A上传的图片地址等于用户B上传的图片地址。
## 分片上传和断点续传
对于大文件，可以自己选择分片上传或者断点续传。COS服务中有这个服务。

## 空间部分修改
### 空间级别和限额控制
目前的上传图片的功能已经比较复杂了，如果要增加一个新的校验规则，免不了要重新修改代码，但是在屎山上拉屎不是我们的风格。
当技术实现比较复杂的时候，不妨考虑一下对业务进行优化。
比如：
- 单张图片最大才2MB，那么即时空间已经满了在允许用户上传一张图片又有何妨呢？
- 即使用户在超额限制之前瞬间上传了大量的图片，但是对系统的影响并不大。后续可以通过限流 + 定时任务检测空间等策略。

## 图片功能扩展
- 图片扩展
- 基础属性搜索
- 以图搜图
- 颜色搜索
- 图片分享
- 链接分享
- 扫码分享
- 图片批量管理
- 批量修改信息
- 批量重命名

### 以图搜图
### 颜色搜索
在筛选图片的时候可以进行颜色匹配，比如选择橙色的，类似的效果可以参考Bing图片的官网中的颜色筛选。
#### 使用范围
我们这个功能需要在空间内使用，主要是考虑到公共图库的图片数量很庞大，直接进行颜色匹配会导致搜索速度很慢。
#### 方案设计
##### 流程
为了提升性能，避免每一次搜索实时计算图片色调属性，建议在图片上传成功之后提取主色调到数据库中，令存储为一个字段。
1. 提取颜色：通过图像识别技术（云服务API或者OpenCV图像处理库）提取图片的颜色特征，可以采用主色调、颜色直方图方法表示图片的颜色特征。此处我们选择的是主色调。
2. 存储颜色特征：将提取的颜色数据存储在数据库中，以便于后续检索。
3. 用户查询输入：用户通过颜色选择器、RGB值输入、或者预定颜色名称指定颜色查询条件。
4. 计算相似度：根据用户指定颜色，与数据库中的 颜色 进行相似度计算（欧氏距离、余弦相似度方法）。
5. 返回结果：由于空间内的图片数量较少，可以按照图片与目标颜色的相似度进行排序，有限返回最符合用户要求的图片，而不是只返回完全符合指定色调的图片。
##### 如何获取图片主色调
我们存储图片使用的COS对象存储服务已经帮助我们整合了数据万象，自带获取图片主调的功能。
##### 如何计算颜色相似度
数据库不支持直接按照图片颜色检索，用LIKE检索不符合颜色特征，可以使用算法来实现。
此处使用的是**欧几里得距离算法**，颜色使用RGB来表示，可以通过计算两种颜色RGB值之间的欧几里得距离判断相似度。
### 图片分享
#### 方案设计
主要以前端为主，不涉及到后端开发
1. 通用分享组件：由于网站多个位置都可以触发共享，可以开发一个通用的弹窗分享组件，并在各个页面引入。用户点击分享时，分享弹窗会弹出，并展示多种不同的分享方式。
2. 分享入口：可以在图片详情页、个人空间的图片卡片操作栏中加上分享入口。
3. 复制链接分享：可以直接利用AntDesign中的可复制文本组件，也可以采用第三方copy-text-to-clipboard库实现。
4. 移动端扫码分享：可以使用组件库的qrcode组件，也可以使用第三方的qrcode组件，原理是将分享链接转成二维码，用户扫码之后可以直接访问。

## AI 图片编辑
此处主要是前端的开发
1. 在图片上传图片，如果用户已上传图片，页面会展示"编辑图片"按钮。
2. 用户点击编辑图片之后，打开图片编辑的弹窗组件，支持裁剪、旋转等操作。
3. 用户确认编辑之后，调用图片上传接口，编辑之后的新图片保存到平台，更新图片信息。
### AI扩图API
> 有一个很坑的点：
> 前端如果传递的是xScale，是无法直接赋值到xScale，但是传递的是xscale是可以赋值成功的，原因是SpringMVC对于第二个字母是大写的参数无法直接映射。
> 解决方案是：给这些字段增加`@JsonProperty`注解即可.
```java
/**
 * 可选，图像居中，在水平方向上按比例扩展，默认值 1.0，范围 [1.0, 3.0]
 */
@Alias("x_scale")
@JsonProperty("xScale")
private Float xScale;

/**
 * 可选，图像居中，在垂直方向上按比例扩展，默认值 1.0，范围 [1.0, 3.0]
 */
@Alias("y_scale")
@JsonProperty("yScale")
private Float yScale;
```
> 为什么SpringMVC要这么设计呢？因为Jackson在处理字段名与JSON属性名映射时，会依赖java的标准命名规范和反射API。
## 图库分析
#### 分析类需求的实现流程
1. 数据采集：从数据源获取到原始数据，提前明确涉及的表和字段，必要的时候采取分页查询处理大量数据。
2. 数据预处理：对数据进行清洗、加工和格式化。包含过滤无效数据（逻辑删除或者审核未通过）、解析复杂字段（JSON的tags）通过字段关联补充上下文信息。
3. 数据计算：根据需求进行分组、聚合、排序等，从而计算关键指标，比如计算空间哥哥分类图片占用比例、用户上传图片的时间趋势，可以根据场景调整计算方案，如果是比较大的数据量，采用Spark之类的大数据计算组件做离线计算；对于数据实时性要求较高的实时分析场景，可以用Flink做流失处理。
4. 数据存储（可选）：针对频繁查询的分析结果，可将结果数据存储为单独的表或缓存，减少重复计算，提高查询效率。
5. 数据接口设计：为前端提供统一接口，从而支持查询和展示，需要考虑到数据量比较大导致前段渲染卡顿的情况，按需精简返回的字符串、分页查询等。
6. 数据可视化：通过图表直观展示分析效果，前端可以使用ECharts等可视化库渲染，也可以让后端生成图表图片并且返回。
### 实现方案
我们发现，管理员对公共图库以及全空间的分析需求，与用户对自己空间的分析需求本质上是相同的，唯一的区别就是图片范围的选择。
1. 用户分析自己的空间
```sql
select category, SUM(picSize) as totalSize
FroM picture
where spaceId = xxx
group by category
```
2. 管理员分析公共图库，SQL为例
```sql
select category, SUM(picSize) as totalSize
FROM picture
WHERE spaceId is null
group by category
```
3. 管理员分析全部空间，SQL示例
```sql
select category, SUM(picSize) as totalSize
FROM picture
group by category
```
除了where不一样之外，其他的都是一样的。所以我们设计统一的接口，通过传递不同的请求参数，同时满足上述需求，参数含义和优先级如下（优先级从高到低）
（1）queryAll字段：为true时查询全部空间，仅供管理员使用。
（2）queryPublic字段：为true时查询公共图库，仅管理员可以使用。
（3）spaceId字段：仅在queryAll和queryPublic为false时使用，表示对特定空间进行分析，仅空间创建人和管理员可以使用。
